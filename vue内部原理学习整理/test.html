<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>
<body>
  <div id="app">
    <div>
      <p class="title">我的英雄是</p>
      <p v-text="heroName" class="content"></p>
    </div>
  </div>
</body>
<script>
  class Vue {
    constructor (option) {
      this._data = option.data
      this.$el = document.querySelector(option.el)
      this.observerable(this._data)
      Object.keys(option.data).forEach(val => {
        this.setProxy(this, val)
      })
      this._render()
    }
    // 将属性变成可观测的
    definedReactive (obj, key, val) {
      Object.defineProperty(obj, key, {
        enumerable: true,
        configurable: true, // 设置成可设置的 不然会报Uncaught ReferenceError: data is not defined
        get: () => {
          console.log('正在获取' + key)
          return val
        },
        set: (newVal) => {
          val = newVal
          console.log('正在设置' + key + '值为' +  newVal)
        }
      })
    }
    // 遍历每个对象，将属性编程可观察的
    observerable (obj) {
      Object.keys(obj).forEach(val => {
        this.definedReactive(obj, val, obj[val])
      })
    }
    // 设置代理,直接从vue实例操作属性，而不必用_data操作属性
    setProxy (data, key) {
      Object.defineProperty(data, key, {
        enumerable: true,
        get: () => {
          return data._data[key]
        },
        set: (newVal) => {
          data._data[key] = newVal
        }
      })
    }
    _bindText () {
      this.queryText(this.$el)
    }
    _render () {
      this._bindText()
    }
    queryText (node) {
      let textList = node.querySelectorAll('[v-text]')
      let makedArr = Array.from(textList)
      makedArr.forEach(val => {
        let attribute = val.getAttribute('v-text')
        val.innerHTML = this._data[attribute]
      })
    }
  }
  let vue = new Vue({
    data: {
      heroName: 'peter'
    },
    el: '#app'
  })
  window.setTimeout(() => {
    vue.heroName = 'tom'
    vue._render()
  }, 2000)
</script>
